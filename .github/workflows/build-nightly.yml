name: Nightly Build

on:
  schedule:
    - cron:  '0 0 * * *'

jobs:

  windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - uses: microsoft/setup-msbuild@v2
      with:
        msbuild-architecture: x64

    - name: Initial compile
      shell: cmd
      run: |
        MSBuild WickedEngine.sln /t:OfflineShaderCompiler /m /p:Configuration=Release /p:Platform=x64
    - name: Generate shader dump
      shell: cmd
      run: |
        cd "WickedEngine"
        "../BUILD/x64/Release/OfflineShaderCompiler/OfflineShaderCompiler.exe" hlsl6 spirv shaderdump strip_reflection
    - name: Recompile with shader dump
      shell: cmd
      run: |
        MSBuild WickedEngine.sln /t:clean /m /p:Configuration=Release /p:Platform=x64
        MSBuild WickedEngine.sln /t:Editor_Windows /m /p:Configuration=Release /p:Platform=x64

    - name: Move files
      shell: cmd
      run: |
        move BUILD\x64\Release\Editor_Windows\Editor_Windows.exe .\
        move Editor\config.ini .\
        move Editor\startup.lua .\
        move Editor\languages .\
        move Editor\fonts .\

    - name: Package Editor
      uses: actions/upload-artifact@v4
      with:
        name: Editor (Windows)
        path: |
          languages/
          fonts/
          config.ini
          startup.lua
          Editor_Windows.exe


  linux:
    name: linux (gcc)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install libsdl2-dev

    - name: Compile with embedded shaders
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DWICKED_EMBED_SHADERS=YES -DWICKED_ENABLE_IPO=NO
        make -C build -j$(nproc)

    - name: Move files
      run: |
        mv build/Editor/Editor ./Editor_Linux
        mv Editor/config.ini ./
        mv Editor/startup.lua ./
        mv Editor/fonts ./

    - name: Package Editor
      uses: actions/upload-artifact@v4
      with:
        name: Editor (Linux)
        path: |
          fonts/
          config.ini
          startup.lua
          Editor_Linux

  macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Compile Offlineshadercompiler
      run: |
        xcodebuild clean build -project WickedEngine/offlineshadercompiler.xcodeproj -scheme offlineshadercompiler -configuration Release

    - name: Generate shader dump
      run: |
        BUILD_PATH="$(xcodebuild -project WickedEngine/offlineshadercompiler.xcodeproj -scheme offlineshadercompiler -configuration Release -showBuildSettings | grep -m 1 "BUILT_PRODUCTS_DIR" | awk -F' = ' '{print $2}')"
        cd WickedEngine
        "${BUILD_PATH}/offlineshadercompiler" metal rebuild shaderdump
        cd ..

    - name: Build Editor
      run: |
        xcodebuild clean build -project Editor/Editor.xcodeproj -scheme Editor -configuration Release

    - name: Move files
      run: |
        BUILD_PATH="$(xcodebuild -project Editor/Editor.xcodeproj -scheme Editor -configuration Release -showBuildSettings | grep -m 1 "BUILT_PRODUCTS_DIR" | awk -F' = ' '{print $2}')"
        mv "${BUILD_PATH}/Editor" ./Editor_MacOS
        mv Editor/config.ini ./
        mv Editor/startup.lua ./
        mv Editor/languages ./
        mv Editor/fonts ./

    - name: Package Editor
      uses: actions/upload-artifact@v4
      with:
        name: Editor (Mac OS)
        path: |
          languages/
          fonts/
          config.ini
          startup.lua
          Editor_MacOS

  content:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - name: Package Content
      uses: actions/upload-artifact@v4
      with:
        name: Content
        path: |
          Content/Documentation
          Content/models
          Content/scripts
          Content/terrain
